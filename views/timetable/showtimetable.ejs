<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
		
		<title>시간표</title>
		
  		<link href="/public/semantic.min.css" rel="stylesheet" >
		<style>
			* {
				padding:0;
				margin:0;
				box-sizing:border-box;
			}
			
			html {
				width:100%;
				height:100%;
			}
			
			body {
				width:100%;
				height:100%;
				color: #000;
				background-color: #fff;
                <!-- 팝업 스타일 --> 
                 display: block; 
                 margin: 0 auto; 
                 font-size: 16px; 
                  
			}
					
			.container {
				margin-right: auto;
				margin-left: auto;
				padding-left: 20px;
				padding-right: 20px;
			}

			#board_title {
				font-size:1.2em;
				font-weight:bold;
				color:teal;
			} 
            table {
                  border-spacing: 10px;
                  empty-cells: show; 
                  border-collapse: collapse; 
                  border-right:1px solid;
                  border-left:1px solid; 
                  border-top: 1px solid; 
                  border-bottom: 1px solid;
                  
            }
            table tr{
                height: 100px;
                border: 1px solid;   
                empty-cells: show; 
                border-right:1px solid;
                border-left:1px solid; 
                border-top: 1px solid;
                border-bottom: 1px solid;
            }
            
            td {
              width: 30px;
              height: 50px;
              border: 1px solid; 
              vertical-align: top;   
              empty-cells: show;
              border-right:1px solid;
              border-left:1px solid;
              border-top: 1px solid; 
              border-bottom: 1px solid;        
            }
       <!-------------팝업 스타일 경계선------------------>
         
     h1{ 
         font-family: 'Oswald', sans-serif; 
         font-size: 30px; 
         color: #216182; 
     } 
     label { 
         display: block; 
         margin-top: 20px; 
         letter-spacing: 2px; 
     } 
     .modalform { 
         margin: 0 auto; 
         width: 459px; 
     } 
     .modalinput { 
         width: 439px; 
         height: 27px; 
         background-color: #efefef; 
         border-radius: 6px; 
         border: 1px solid #dedede; 
         padding: 10px; 
         margin-top: 3px; 
         font-size: 0.9em; 
         color: #3a3a3a; 
     } 
         input:focus, textarea:focus{ 
             border: 1px solid #97d6eb; 
         } 
     
     textarea{ 
         height: 60px; 
         background-color: #efefef; 
     } 
     #modalsubmit{ 
         width: 127px; 
         height: 48px; 
         text-align: center; 
         border: none; 
         margin-top: 20px; 
         cursor: pointer; 
     } 
     #modalsubmit:hover{ 
         color: #fff; 
         background-color: #216282; 
         opacity: 0.9; 
     } 
     #modalcancel { 
         width: 127px; height: 48px; 
         text-align: center; 
         border: none; 
         margin-top: 20px; 
         cursor: pointer; 
     } 
     #modalcancel:hover{ 
         color: #fff; 
         background-color: #216282; 
         opacity: 0.9; 
     }

    .modal { 
         position: fixed; 
         left: 0; 
         top: 0; 
         width: 100%; 
         height: 100%; 
         background-color: rgba(0, 0, 0, 0.5); 
         opacity: 0; 
         visibility: hidden; 
         transform: scale(1.1); 
         transition: visibility 0s linear 0.25s, opacity 0.25s 0s, transform 0.25s; 
     } 
     .modal-content { 
         position: absolute; 
         top: 50%; 
         left: 50%; 
         transform: translate(-50%, -50%); 
         background-color: white; 
         padding: 1rem 1.5rem;   
         border-radius: 0.5rem; 
     } 
     .close-button { 
         float: right; 
         width: 1.5rem; 
         line-height: 1.5rem; 
         text-align: center; 
         cursor: pointer; 
         border-radius: 0.25rem; 
         background-color: lightgray; 
     } 
     .close-button:hover { 
         background-color: darkgray; 
     } 
     .show-modal { 
         opacity: 1; 
         visibility: visible; 
         transform: scale(1.0); 
         transition: visibility 0s linear 0s, opacity 0.25s 0s, transform 0.25s; 
     }      
        </style>
		<script src="/public/jquery-2.1.4.min.js"></script>
		<script src="/public/semantic.min.js"></script>  
        <script type = "text/javascript" src = "http://code.jquery.com/jquery-3.2.1.min.js"></script> 
        <script>  
            
        <% 
        function getStartpoint(point){ //timetable[startpoint] 와 시작 시간이 달라지기 시작하는 시간표의 인덱스 반환
        var i = point;  
        if(i==timetable.length-1){return (i+1*1);} //맨 마지막 시간표 하나만 시작 시간이 다를 때 대비
            for(; i< timetable.length; i++){
                if(timetable[point].courses.starttime<timetable[i].courses.starttime){
                break;
                } 
            }  
        return i*1;
        }
        %> 
        // 폼에서 액션 실행 전에 체크하는 것. id: 해당 폼의 id, comment: 실행 확인 후 멘트   
        function checkbeforeaction(id, comment){ 
            var check = confirm(comment); 
            if(check){
                document.getElementById(id).submit(); 
            } 
        }  
            
        </script>
	</head>
	<body>
    <script>
    
     //timetable에 시간표가 있으면 timetable은 array형식이고, 시간표가 없으면 array가 아니라서 구분해야 한다.
        <% if(typeof timetable[0] == 'undefined'){ 
                var title = timetable.title; 
                var idtoread = timetable._id;  
                var userid = timetable.userid; 
                var isdefaultview = timetable.isdefaultview;
            } 
            else{
                var title = timetable[0].title; 
                var idtoread = timetable[0]._id;
                var userid = timetable[0].userid;
                var isdefaultview = timetable[0].isdefaultview;
            }
        %>    
    </script>	     
    	<div class="container">
    		<br>
    		 
			<div class="ui raised segment"> 
				<a class="ui blue ribbon label" >시간표</a>
                
                <div align = "right">
                    
                    <!-- 시간표 삭제할 지 정하는 버튼-->
                    <form style="display:inline" action= "/process/deletetimetable/<%=idtoread%>" id = "deletetimetable" method="post"> 
                    <input type = "button"  value="시간표 삭제" onclick = "checkbeforeaction('deletetimetable', '해당 시간표를 삭제할까요?')" >
                    </form>
                    
                    <!-- 기본 보기로 설정/해제할 지 정하는 버튼. 이미 기본 보기로 설정 되어 있다면, 기본 보기 해제 버튼 만--> 
                    <%if(isdefaultview){ %>
                        <form style="display:inline" id="unsetdefaultview" action = "/process/unsetdefaultview" method="post"> 
                        <input type = "submit"  value="기본 보기 설정 해제">
                        <input type hidden = "text" name = "id" value= '<%=idtoread%>'>
                        <input type hidden = "text" name = "userid" value= '<%=userid%>'>
                        </form> 
                    
                    <%}else{%>
                        <form style="display:inline" id="setdefaultview" action = "/process/setdefaultview" method="post"> 
                        <input type = "submit"  value="기본 보기로 설정">
                        <input type hidden = "text" name = "id" value= '<%=idtoread%>'>
                        <input type hidden = "text" name = "userid" value= '<%=userid%>'>
                        </form>
                    <%}%>
                    <!--시간표 리스트로 돌아가기 위한 버튼-->    
                    <form style="display:inline" method="post" action = "/process/listtimetable/<%=userid%>"> 
                    <input type = "submit"  value="시간표 항목으로">
                    </form>
                </div> 
                
                <br><br> 
                      
                            <h1 align = "center"><%=title%></h1> 
			   				<table class="table table-striped posts" width = "100%" height = "100%">   
                            <thead align = "center"> 
                                <tr>
                                <td></td>
                                <td style="height: 50%">Mon</td>
                                <td>Tue</td>
                                <td>Wed</td>
                                <td>Thu</td>
                                <td>Fri</td> 
                            <%if(maxday>=5){%>
                                <td>Sat</td> 
                            <%}%>
                            <%if(maxday==6){%>
                                <td>Sun</td> 
                            <%}%> 
                               </tr>
                            </thead> 
                            <tbody height = "100%"> 
                            <%
                                var startpoint = 0; //시작 시간이 동일한 courses의 가장 앞 인덱스      
                               while(startpoint<timetable.length){ %>
                                
                                <tr> 
                                <% var starttimehour = Math.floor(timetable[startpoint].courses.starttime/100,10); 
                                   
                                  var starttimeminute = timetable[startpoint].courses.starttime%100; 
                                   var endtimehour = Math.floor(timetable[startpoint].courses.endtime/100); 
                                   var endtimeminute = timetable[startpoint].courses.endtime%100 %>    
                                <td>
                                    <%=starttimehour%>:<%if(starttimeminute<10){%>0<%}%><%=starttimeminute%>
                                </td> 
                                <%  
                                    var currentstartpoint = startpoint; 
                                    var nextstartpoint = getStartpoint(currentstartpoint); 
                                    
                                    var tdmoved = 0; //현재 <td>를 몇 번이나 했는 지 누적하는 변수
                                    
                                    for(;startpoint<nextstartpoint;startpoint++){
                                        for(;tdmoved<timetable[startpoint].courses.day-1;tdmoved++){%> 
                                    <!-- 요일 만큼 테이블의 가로 칸 이동-->
                                            <td></td> 
                                        <%}%>
                                        <!-- 해당하는 위치에 수업 정보 기록--> 
                                        <td rowspan="<%=(timetable[startpoint].courses.endtime - timetable[startpoint].courses.starttime)/100 +1 %>"> 
                                        <%console.log("starttimeminute: ",starttimeminute);%>
                                        <%=timetable[startpoint].courses.subjectname %><br>
                                        <%=timetable[startpoint].courses.professorname %><br>
                                        <%=starttimehour%>:<%if(starttimeminute<10){%>0<%}%><%=starttimeminute%> ~ 
                                        <%=endtimehour%>:<%if(endtimeminute<10){%>0<%}%><%=endtimeminute%> 
                                        <br> 
                                           
                                        <form action = "/process/deletecourse" method="post" id = "deletecourse">  
                                           <input type = "button" value = "삭제" onclick="checkbeforeaction('deletecourse', '해당 과목을 삭제할까요?')">
                                           <input type hidden = "text" name = "id" value = '<%=timetable[startpoint]._id%>' width = "10%"> 
                                             <input type hidden = "text" name = "courseid" value = '<%=timetable[startpoint].courses._id%>'width = "10%">        
                                        </form>     
                                        </td>
                                <%}//for문 닫기
                                
                                /*9시 시작 수업은 월 ~ 금 까지 있는데, 10시 수업은 월 ~ 금요일 전 까지 밖에 없는 경우 빈칸 채워 넣기*/    
                                if(nextstartpoint<=timetable.length){  
                                   for(var i = timetable[nextstartpoint-1].courses.day; i<maxday;i++){%>
                                        <td></td>   
                                    <%}
                                }          
                                %>
                                </tr>   
                            <%  /*timetable[startpoint-1].courses.endtime == 900 , 
                                timetable[startpoint].courses.starttime == 1100 같은 경우 */  
                                
                                if(nextstartpoint<timetable.length&&timetable[startpoint-1].courses.endtime < timetable[startpoint].courses.starttime){  
                                    var lastendtime = timetable[startpoint-1].courses.endtime; 
                                    var nextstarttime = timetable[startpoint].courses.starttime; 
                                    for(;lastendtime<nextstarttime;lastendtime+=100){
                                        %> 
                                    <tr>
                                    <td><%= lastendtime %></td>
                                    <% for(var i = 0; i<=maxday; i++){%>
                                            <td></td>
                                        <%}%>
                                    </tr>
                                    <%}
                                }
                                
                                  
                            } %><!-- while문 닫기-->      
                            </tbody> 
                            </table> 
                        </div>  
                    <button class="trigger">수강과목 추가</button> <!-- 과목 추가 버튼-->
                    </div>  
        
       
        <div class="modal"> <!-- 과목 추가 시 나타나는 모달 폼-->
         <div class="modal-content"> 
             <span class="close-button">&times;</span>
             <h1 class="title">수강 과목 추가</h1> 
             <form action = "/process/addcourse" method="POST" class = "modalform">  
               과목명 <input type="text" name="subjectname" required="required" class="modalinput"><br>
               교수명 <input type="text" name="professorname" class="modalinput"><br> 
               수강요일 <select name ="day" required = "required">  
                            <option value=0>월</option>
                            <option value=1>화</option>
                            <option value=2>수</option> 
                            <option value=3>목</option>
                            <option value=4>금</option>
                            <option value=5>토</option>
                            <option value=6>일</option> 
                        </select><br><br>
                 
                시작시간 <select name="starttimehour" required="required"> 
                        <%for(var i=0; i<24; i++){ 
                            if(i<10){ %>
                                <option value= "<%=i%>">0<%=i%></option>
                                <%continue;}%> 
                            <option value= "<%=i%>"><%=i%></option> 
                            <%}%>
                        </select> 시
                        
                        <select name="starttimeminute" required="required"> 
                        <%for(var i=0; i<60; i+=10){ 
                            if(i<10){ %>
                                <option value= "<%=i%>">0<%=i%></option>
                                <%continue;}%>  
                            <option value= "<%=i%>"><%=i%></option>
                        <%}%>
                        </select>분 &nbsp;&nbsp;/&nbsp;&nbsp;
               종료시간 <select name="endtimehour" required="required"> 
                        <%for(var i=0; i<24; i++){ 
                            if(i<10){ %>
                                <option value= "<%=i%>">0<%=i%></option>
                                <%continue;}%> 
                            <option value= "<%=i%>"><%=i%></option> 
                            <%}%>
                        </select> 시
                        
                        <select name="endtimeminute" required="required"> 
                        <%for(var i=0; i<60; i+=10){ 
                            if(i<10){ %>
                                <option value= "<%=i%>">0<%=i%></option>
                                <%continue;}%>  
                            <option value= "<%=i%>"><%=i%></option>
                        <%}%>
                        </select>분<br>  
               <input type hidden = "text" name = "id" value = '<%= idtoread%>'>          
               <input type="button" id="modalcancel" value="취소" > 
               <input type="submit" id="modalsubmit" value="추가"> 
             </form> 
         </div> 
     </div>
	</body> 
    <script type="text/javascript"> //모달 관련         
         var modal = document.querySelector(".modal");  
         var trigger = document.querySelector(".trigger");
         var closeButton = document.querySelector(".close-button"); 
         var cancelButton = document.querySelector("#modalcancel"); 
        
        function toggleModal() {
             modal.classList.toggle("show-modal"); 
         } 
            
        function windowOnClick(event) { 
             if (event.target === modal) { 
                 toggleModal(); 
             }  
         }

        trigger.addEventListener("click", toggleModal);  
        closeButton.addEventListener("click", toggleModal); 
        modalcancel.addEventListener("click", toggleModal); 
        window.addEventListener("click", windowOnClick);  
     </script>
</html>

